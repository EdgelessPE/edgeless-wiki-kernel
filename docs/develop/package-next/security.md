# 资源包安全

安全同样是下一代资源包需要考虑的因素，但是由于以下两个致命的因素缺失问题：

- PE加载时无法确保能连接到因特网，因此无法访问可信凭据中心 edgeless.top 获得开发者签名的公钥
- PE加载时无法确保能访问 TPM 模块或是可靠的本地可信凭据管理器，且将私钥保存在硬盘中是非常危险的

综合考虑安全校验带来的额外性能开销，我们仅会使用混淆级别的简易安全措施保证资源包的基础安全，而无法*在加载阶段*验证某个资源包是由可信的开发者打包的，或是具备识别通过精心的二进制修改制作的恶意资源包的能力。不过不用担心，我们提供的安全措施能够有效地抵御大部分的基础恶意修改，达到“普通人不会诱骗，高手不屑于诱骗”的效果。

## 资源包自锁
使用官方构建工具构建的合法资源包会在 `package.lock` 文件中加入经对称加密后的 `package.toml` 生成时间戳信息，在加载时加载器会将此时间戳与 `package.toml` 和压缩包的修改时间戳进行比对，如果时间戳与 `package.toml` 修改时间戳不一致或与压缩包修改时间戳的时间差大于容忍范围（5分钟）则会拒绝加载此资源包并发出警告。

这意味着 `package.toml` 文件必须严格通过构建工具的验证，不过构建者可以在构建完成后的5分钟内不通过构建工具再次构建而直接修改资源包内的内容；而5分钟后资源包自锁就会形成，此时不通过构建工具再次构建而直接修改资源包内的内容会导致加载器拒绝加载此资源包。

资源包自锁可以在不依赖于可信凭据中心和 TPM 模块的前提下确保 `package.toml` 文件通过了规则校验和逻辑证明，且资源包内的内容未被构建者外的人修改过（由于官方基础设施的审核与缓存机制，其他人几乎不可能在完成构建后的5分钟内从官方渠道获得资源包），同时拥有近乎忽略不计的性能开销。

## 连接到 Edgeless 可信凭据中心
引入一个位于网络上的可信凭据中心可以有效地解决一些无法由自锁探测到的问题。当用户插入启动盘并启动官方版本的 Edgeless Hub 时，Hub 会（调用 ept）自动连接到位于 edgeless.top 的 Edgeless 可信凭据中心获取官方仓库的资源包时间戳（通信过程使用 SSL/TLS 协议加密），然后与启动盘中的资源进行对比。此时如果检测到文件名与时间戳不匹配的资源包或官方仓库中没有的资源包，Edgeless Hub 会发出警告提醒用户处理这些潜在的安全隐患。

:::tip
除了在 Edgeless Hub 启动时执行检查，在 PE 内执行二次加载时如果连接到了互联网则也会进行检查，更高频率的安全校验可以帮助用户尽早发现安全隐患。
:::

对于 Edgeless 官方镜像源的插件包，每个插件包在通过审核之前都会经过实时更新病毒特征库的 [Clam Anitvirus](https://www.clamav.net/) 软件扫描，保障插件包内容的安全。此外 [Edgeless QA](qa-system.md) 中还包含了其他流程以对即将上架的资源包执行全面审查。

## 限制的步骤功能
对于某些需要默认启用自动完全加载的类型的资源包，例如主题资源包或驱动资源包，我们会禁用运行脚本、命令执行等不安全的步骤。

## 第三方安全软件的辅助检查
由于 Edgeless 资源包的拓展名保留了 `.7z` 且包本体不设密码，因此在正常系统中可以借助第三方安全软件的U盘自动扫描功能扫描资源包内的文件，以尽快发现离线状态下的木马文件。不过这也许会导致误报的产生，请综合 Edgeless Hub 给出的安全检查结果酌情考虑。

## 小心行事！
由于开头提到的两个限制条件影响，Edgeless 资源包在理论上完全无法抵御精心设计的恶意攻击，因此我们并没有引入太多的安全特性。确保安全的最佳实践还是需要你的小心行事，保持良好的上网习惯，不要轻易信任不明文件，不要随意关闭安全软件，留心高占用的后台程序，这样才能使你尽可能远离网络威胁。